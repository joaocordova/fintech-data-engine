graph TD
    %% Source Layer
    subgraph Sources
        Alpaca["Alpaca Markets API<br/>(Stocks/Crypto)"]
        Reddit["Reddit API<br/>(Sentiment)"]
    end

    %% Ingestion Layer
    subgraph Ingestion["Ingestion Layer (Python/AKS)"]
        Stream["Streaming Listener<br/>(FastAPI + WebSockets)"]
        Batch["Batch Backfill<br/>(Python Job)"]
        Contracts["Data Contracts<br/>(Pandera/Pydantic)"]
        
        Alpaca -->|Real-time| Stream
        Alpaca -->|Historical| Batch
        Reddit -->|Batch/Poll| Batch
        
        Stream --> Contracts
        Batch --> Contracts
    end

    %% Storage Layer (Data Lake)
    subgraph Storage["Azure Data Lake Gen 2 (ADLS)"]
        Bronze[("Bronze Layer<br/>Raw JSON/Parquet")]
        Silver[("Silver Layer<br/>Cleaned Delta/Parquet")]
        Gold[("Gold Layer<br/>Business Aggregates")]
    end

    %% Processing Layer
    subgraph Transformation["Transformation (dbt Core)"]
        dbt_bronze["Staging Models"]
        dbt_silver["Cleansing & Deduping"]
        dbt_gold["SCD Type 2 & Facts"]
    end

    %% Orchestration
    subgraph Orchestrator["Orchestration"]
        Airflow["Apache Airflow"]
    end

    %% Machine Learning Layer
    subgraph ML["Machine Learning (Prophet + MLflow)"]
        Features["Feature Engineering<br/>(Lagged Sentiment)"]
        Training["Model Training<br/>(Prophet)"]
        Registry["Model Registry<br/>(MLflow)"]
        Inference["Inference API<br/>(FastAPI)"]
    end

    %% Serving Layer
    subgraph Serving["Serving Layer"]
        Postgres[("Azure Postgres DB<br/>Analytical Serving")]
        Dashboard["Streamlit Dashboard"]
    end

    %% Flows
    Contracts -->|Valid Data| Bronze
    
    Airflow -->|Trigger| Transformation
    
    Bronze --> dbt_bronze
    dbt_bronze --> Silver
    Silver --> dbt_silver
    dbt_silver --> Gold
    dbt_gold --> Postgres
    
    Gold --> Features
    Features --> Training
    Training --> Registry
    Registry --> Inference
    Inference --> Dashboard
    Postgres --> Dashboard

    %% Observability
    subgraph Observability
        Soda["Soda/Great Expectations<br/>Data Quality"]
        Monitor["Azure Monitor"]
    end

    Transformation -.->|Quality Checks| Soda
